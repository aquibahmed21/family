(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))i(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function n(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerPolicy&&(o.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?o.credentials="include":t.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(t){if(t.ep)return;t.ep=!0;const o=n(t);fetch(t.href,o)}})();let f=null,y={};const R=window.location.hostname==="localhost"?"http://localhost:3000/":"https://web-push-3zaz.onrender.com/";document.addEventListener("DOMContentLoaded",function(){const e=localStorage.getItem("role")||"reader";document.querySelector(".container").setAttribute("role",e),J(),V()});function J(){fetch(R+"family").then(e=>e.json()).then(e=>{f=e,document.getElementById("loadingState").style.display="none",document.getElementById("treeContent").style.display="block",I()}).catch(e=>{document.getElementById("loadingState").innerHTML=`
            <i class="fas fa-exclamation-triangle" style="color: var(--warning-color); margin-right: 0.5rem;"></i>
            Failed to load family tree: ${e.message}
          `})}function x(){if(!f||!f.rootPerson)return;document.getElementById("familyName").textContent=f.familyName||"Family Tree";const e=document.getElementById("treeContent");e.innerHTML="",e.appendChild(E(f.rootPerson,null,"root",0))}function U(){const e=[];function s(n,i){n&&(e.push({name:n.name||"",serial:n.serial||null,gender:n.gender||"",maritalStatus:n.maritalStatus||"",spousesCount:n.spouses&&n.spouses.length||0,childrenCount:n.children&&n.children.length||0,path:i}),n.spouses&&n.spouses.forEach((t,o)=>s(t,`${i}.spouses[${o}]`)),n.children&&n.children.forEach((t,o)=>s(t,`${i}.children[${o}]`)))}return f&&f.rootPerson&&s(f.rootPerson,"root"),e}function V(){const e=document.getElementById("searchInput"),s=document.getElementById("searchResults"),n=document.getElementById("applyFiltersBtn"),i=document.getElementById("clearFiltersBtn"),t=document.getElementById("backToResultsBtn"),o=document.getElementById("filterGender"),a=document.getElementById("filterMarital"),l=document.getElementById("filterChildren"),r=document.getElementById("filterSpouses"),c=document.getElementById("filterResults");if(!e||!n||!c)return;const d=()=>{var h;return((h=document.querySelector(".container"))==null?void 0:h.getAttribute("role"))||"reader"};let p="";function m(){const h=(e.value||"").trim().toLowerCase(),T=(o==null?void 0:o.value)||"",P=(a==null?void 0:a.value)||"",O=(l==null?void 0:l.value)||"",H=(r==null?void 0:r.value)||"",C=U().filter(u=>{if(T&&u.gender!==T||P&&u.maritalStatus!==P||O==="yes"&&u.childrenCount<=0||O==="no"&&u.childrenCount>0||H==="yes"&&u.spousesCount<=0||H==="no"&&u.spousesCount>0)return!1;if(h){const v=u.name.toLowerCase().includes(h),S=h.startsWith("#")?u.serial!==null&&`#${u.serial}`===h:u.serial!==null&&`${u.serial}`===h;if(!v&&!S)return!1}return!0}).slice(0,300),k=d();c.innerHTML=C.length?C.map(u=>{const v=k==="reader"?"Private":u.name||"Unnamed",S=k==="reader"?"":u.maritalStatus?" 路 "+u.maritalStatus:"";return`<div class="result-item" data-path="${u.path}">
         <strong>${v}</strong>
         <small>#${u.serial??"N/A"} 路 ${u.gender}${S} 路 Sp:${u.spousesCount} 路 Ch:${u.childrenCount}</small>
       </div>`}).join(""):'<div class="text-muted">No results</div>',c.onclick=u=>{const v=u.target.closest(".result-item");v&&D(v.getAttribute("data-path"))},s&&(s.style.display="none",s.innerHTML=""),p=c.innerHTML;const q=document.getElementById("resultsCount");q&&(q.textContent=C.length?`Results (${C.length})`:"")}let g=null;e.addEventListener("input",()=>{g&&cancelAnimationFrame(g),g=requestAnimationFrame(()=>{m(),g=null})}),n.addEventListener("click",m),o==null||o.addEventListener("change",m),a==null||a.addEventListener("change",m),l==null||l.addEventListener("change",m),r==null||r.addEventListener("change",m),i&&i.addEventListener("click",()=>{o&&(o.value=""),a&&(a.value=""),l&&(l.value=""),r&&(r.value=""),e&&(e.value=""),c.innerHTML="";const h=document.getElementById("resultsCount");h&&(h.textContent="")});const M=document.getElementById("clearSearchBtn");M&&M.addEventListener("click",()=>{e&&(e.value=""),m()}),t&&t.addEventListener("click",()=>{c.innerHTML=p,t.style.display="none"})}async function D(e){if(!e)return;const s=document.getElementById("backToResultsBtn");s&&(s.style.display="inline-flex");const n=[];let i="root";const t=/(?:^|\.)((?:spouses|children))\[(\d+)\]/g;let o;for(;(o=t.exec(e))!==null;){const l=o[1],r=o[2];n.push(`${i}.${l}`),i=`${i}.${l}[${r}]`}n.forEach(l=>{y[l]=!0}),x();for(const l of n){const r=`section-${l.replace(/[\[\].]/g,"-")}`,c=document.getElementById(r);c&&c.classList.contains("collapsed")&&(b(l),await new Promise(d=>requestAnimationFrame(d)))}await new Promise(l=>requestAnimationFrame(l));const a=document.querySelector(`.member-card[data-path="${e}"]`);a&&(a.scrollIntoView({behavior:"smooth",block:"center"}),a.classList.add("highlight"),a.addEventListener("animationend",()=>{a.classList.remove("highlight")},{once:!0}))}function E(e,s,n,i){const t=document.createElement("div");t.className="member-card"+(e.gender=="Female"?" female":" male"),t.style.animationDelay=`${i*.1}s`,t.setAttribute("data-path",n);const o=e.dod&&e.dod.trim()!==""||e.status&&e.status.toLowerCase()==="deceased",a=o?"var(--text-muted)":"var(--success-color)",l=e.image?`<img src="${e.image}" alt="${e.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
           <i class="fas fa-user" style="display: none;"></i>`:'<i class="fas fa-user"></i>',r=[{icon:"venus-mars",label:"Gender",value:e.gender||"Not specified"},{icon:"heart",label:"Status",value:e.maritalStatus||"Not specified"},{icon:"pray",label:"Religion",value:e.religion||"Not specified"}];w(e.dob)&&r.push({icon:"calendar-alt",label:"Born",value:w(e.dob)||"Unknown"}),o&&w(e.dod)&&r.push({icon:"cross",label:"Died",value:w(e.dod)});const c=r.map(d=>`
        <div class="detail-item" value="${d.value}">
          <i class="fas fa-${d.icon}"></i>
          <span>${d.value}</span>
        </div>
      `).join("");if(t.innerHTML=`
        <div class="card-header">
          <div class="avatar-container">
            <div class="avatar">
              ${l}
            </div>
            <div class="status-indicator" style="background: ${a};"></div>
          </div>
          <div class="member-info">
            <div class="member-name">
              ${e.name?`<span class="name">${e.name}</span>`:""}
              <span class="serial-badge">#${e.serial||"N/A"}</span>
              ${e.alternateName?`<span class="alternate-name">(${e.alternateName})</span>`:""}
            </div>
            <div class="member-details">
              ${c}
            </div>
            ${e.notes?`<div class="member-notes"><i class="fas fa-quote-left"></i> ${e.notes}</div>`:""}
          </div>
        </div>
        <div class="card-actions">
          <button class="btn btn-success btn-sm" onclick="showModal('spouse', '${n}')">
            <i class="fas fa-ring"></i> Add Spouse
          </button>
          <button class="btn btn-primary btn-sm" onclick="showModal('child', '${n}')">
            <i class="fas fa-baby"></i> Add Child
          </button>
          <button class="btn btn-warning btn-sm" onclick="showModal('edit', '${n}')">
            <i class="fas fa-edit"></i> Edit
          </button>
          ${n!=="root"?`<button class="btn btn-danger btn-sm" onclick="deleteMember('${n}')"><i class="fas fa-trash"></i> Delete</button>`:""}
        </div>
      `,e.spouses&&e.spouses.length>0){const d=F("spouses",n,e,"Spouses","ring",i);t.appendChild(d)}if(e.children&&e.children.length>0){const d=F("children",n,e,"Children","users",i);t.appendChild(d)}return t.setAttribute("privacy",e.privacy||"public"),t}function F(e,s,n,i,t,o){const a=document.createElement("div");a.className="tree-connections";const l=`${s}.${e}`,r=L(l),c=document.createElement("div");c.className="section-header",c.innerHTML=`
        <button class="toggle-btn ${r?"expanded":""}" >
          <i class="fas fa-chevron-right"></i>
        </button>
        <i class="fas fa-${t}"></i>
        <span class="section-title" mValue="${n[e].length}">${i}</span>
      `,c.onclick=()=>b(l);const d=document.createElement("div");return d.className=`section-content ${r?"expanded":"collapsed"}`,d.id=`section-${l.replace(/[\[\].]/g,"-")}`,r&&n[e].forEach((p,m)=>{const g=E(p,n,`${s}.${e}[${m}]`,o+1);d.appendChild(g)}),a.appendChild(c),a.appendChild(d),a}function b(e){const s=L(e);y[e]=!s;const n=`section-${e.replace(/[\[\].]/g,"-")}`,i=document.getElementById(n),t=i.parentElement.querySelector(".toggle-btn"),o=t.parentElement;if(s){t.classList.remove("expanded"),o.classList.remove("expanded"),i.className="section-content collapsed";const a=()=>{i.removeEventListener("transitionend",a),i.classList.contains("collapsed")&&(i.innerHTML="")};i.addEventListener("transitionend",a)}else{t.classList.add("expanded"),o.classList.add("expanded"),i.className="section-content expanded";const a=e.split("."),l=a[a.length-1],r=a.slice(0,-1).join("."),c=$(r);if(i.innerHTML="",c[l]&&c[l].length>0){const d=a.length-1;c[l].forEach((p,m)=>{const g=E(p,c,`${r}.${l}[${m}]`,d);i.appendChild(g)})}}}function L(e){return y[e]!==!1}function j(){y={},x()}async function z(){if(+await prompt("Enter your secret code to unlock controls")==7889){const s=await prompt("Enter your role to unlock controls");if(["root","admin","writer","reader"].includes(s)){localStorage.setItem("role",s),document.querySelector(".container").setAttribute("role",s);return}}document.querySelector(".container").setAttribute("role","reader")}function I(){function e(s,n){s.spouses&&s.spouses.length>0&&(y[n+".spouses"]=!1,s.spouses.forEach((i,t)=>{e(i,n+`.spouses[${t}]`)})),s.children&&s.children.length>0&&(y[n+".children"]=!1,s.children.forEach((i,t)=>{e(i,n+`.children[${t}]`)}))}e(f.rootPerson,"root"),x()}function G(e,s){const n=document.getElementById("modal"),i=document.getElementById("memberForm"),t=document.getElementById("modalTitle"),o=document.getElementById("modalSubtitle");i.reset();let a={};e==="edit"?(a=$(s),t.textContent="Edit Family Member",o.textContent=`Update information for ${a.name}`,Object.keys(a).forEach(l=>{const r=i.querySelector(`[name="${l}"]`);["gender","privacy","status","maritalStatus"].includes(l)?i.querySelector(`[value="${a[l]}"]`).checked=!0:r&&a[l]!==null&&a[l]!==void 0&&(r.value=a[l])})):(t.textContent=e==="spouse"?"Add Spouse":"Add Child",o.textContent=`Add new ${e} to the family tree`),i.dataset.type=e,i.dataset.path=s,n.classList.add("show")}function N(){document.getElementById("modal").classList.remove("show")}document.getElementById("memberForm").addEventListener("submit",function(e){e.preventDefault();const s=new FormData(this),n={};for(let[o,a]of s.entries())a.trim()&&(n[o]=a.trim());const i=this.dataset.type,t=this.dataset.path;if(i==="edit"){const o=$(t);Object.assign(o,n);const a=document.querySelector(`[data-path="${t}"]`),l=E(o,null,t,0);a.parentNode.replaceChild(l,a)}else{n.serial=B(f.rootPerson)+1,n.spouses=[],n.children=[];const o=$(t);if(i==="spouse"){o.spouses=o.spouses||[],o.spouses.push(n);const l=`${t}.spouses`;if(L(l)){const r=`section-${l.replace(/[\[\].]/g,"-")}`,c=document.getElementById(r);if(c){const d=o.spouses.length-1,p=E(n,o,`${t}.spouses[${d}]`,t.split(".").length);c.appendChild(p)}}}else if(i==="child"){o.children=o.children||[],o.children.push(n);const l=`${t}.children`;if(L(l)){const r=`section-${l.replace(/[\[\].]/g,"-")}`,c=document.getElementById(r);if(c){const d=o.children.length-1,p=E(n,o,`${t}.children[${d}]`,t.split(".").length);c.appendChild(p)}}}const a=document.querySelector(`[data-path="${t}"]`);a&&a.querySelectorAll(".section-title").forEach(r=>{const c=r.textContent;i==="spouse"&&c.includes("Spouses")?(r.textContent="Spouses",r.setAttribute("mValue",o.spouses.length)):i==="child"&&c.includes("Children")&&(r.textContent=`Children (${o.children.length})`,r.setAttribute("mValue",o.children.length))})}N(),A()});function A(){const e=JSON.stringify(f,null,2);fetch(R+"family",{method:"POST",headers:{"Content-Type":"application/json"},body:e}).then(s=>{s.ok?console.log("Family tree exported successfully!"):alert("Error exporting family tree: "+s.statusText)}).catch(s=>{alert("Error exporting family tree: "+s.message)})}function K(e){if(!confirm("Are you sure you want to delete this member and all their descendants?"))return;const s=e.split("."),n=s.pop(),i=s.join("."),t=$(i),o=n.match(/(\w+)\[(\d+)\]/);if(o){const a=o[1],l=parseInt(o[2]);if(t&&t[a]){t[a].splice(l,1);const r=document.querySelector(`[data-path="${e}"]`);r&&r.remove();const c=document.querySelector(`[data-path="${i}"]`);c&&c.querySelectorAll(".section-title").forEach(p=>{const m=p.textContent;a==="spouses"&&m.includes("Spouses")?(p.textContent="Spouses",p.setAttribute("value",t.spouses.length)):a==="children"&&m.includes("Children")&&(p.textContent="Children",p.setAttribute("value",t.children.length))})}}A()}function $(e){if(e==="root")return f.rootPerson;let s=f.rootPerson;const n=/(\w+)\[(\d+)\]/g;let i;for(;(i=n.exec(e))!==null;){const t=i[1],o=parseInt(i[2]);s=s[t][o]}return s}function B(e,s=0){return e&&(e.serial&&e.serial>s&&(s=e.serial),e.spouses&&e.spouses.forEach(n=>{n.serial&&n.serial>s&&(s=n.serial),n.children&&n.children.forEach(i=>{s=B(i,s)})}),e.children&&e.children.forEach(n=>{s=B(n,s)})),s}function w(e){if(!e||e.trim()==="")return null;try{return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}catch{return e}}async function W(){if(!f){alert("No data to export");return}const e=JSON.stringify(f,null,2),s=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(s),i=document.createElement("a");i.href=n,i.download=`${f.familyName||"family_tree"}.json`,document.body.appendChild(i),i.click(),setTimeout(()=>{document.body.removeChild(i),URL.revokeObjectURL(n)},100)}function _(e){const s=e.target.files[0];if(!s)return;const n=new FileReader;n.onload=function(i){try{const t=JSON.parse(i.target.result);t.familyName&&t.rootPerson?(f=t,y={},I(),A(),console.log("Family tree imported successfully!")):alert("Invalid family tree JSON structure.")}catch(t){alert("Error parsing JSON: "+t.message)}},n.readAsText(s),e.target.value=""}document.getElementById("modal").addEventListener("click",function(e){e.target===this&&N()});window.showModal=G;window.closeModal=N;window.deleteMember=K;window.toggleSection=b;window.expandAll=j;window.collapseAll=I;window.exportJSON=W;window.importJSON=_;window.onDBClick=z;window.navigateToPath=D;
