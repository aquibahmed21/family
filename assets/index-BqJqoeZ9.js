(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))s(t);new MutationObserver(t=>{for(const i of t)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function o(t){const i={};return t.integrity&&(i.integrity=t.integrity),t.referrerPolicy&&(i.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?i.credentials="include":t.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(t){if(t.ep)return;t.ep=!0;const i=o(t);fetch(t.href,i)}})();let u=null,h={};const x=window.location.hostname==="localhost"?"http://localhost:3000/":"https://web-push-3zaz.onrender.com/";document.addEventListener("DOMContentLoaded",function(){const e=localStorage.getItem("role")||"reader";document.querySelector(".container").setAttribute("role",e),I()});function I(){fetch(x+"family").then(e=>e.json()).then(e=>{u=e,document.getElementById("loadingState").style.display="none",document.getElementById("treeContent").style.display="block",C()}).catch(e=>{document.getElementById("loadingState").innerHTML=`
            <i class="fas fa-exclamation-triangle" style="color: var(--warning-color); margin-right: 0.5rem;"></i>
            Failed to load family tree: ${e.message}
          `})}function N(){if(!u||!u.rootPerson)return;document.getElementById("familyName").textContent=u.familyName||"Family Tree";const e=document.getElementById("treeContent");e.innerHTML="",e.appendChild(m(u.rootPerson,null,"root",0))}function m(e,n,o,s){const t=document.createElement("div");t.className="member-card"+(e.gender=="Female"?" female":" male"),t.style.animationDelay=`${s*.1}s`,t.setAttribute("data-path",o);const i=e.dod&&e.dod.trim()!=="",l=i?"var(--text-muted)":"var(--success-color)",a=e.image?`<img src="${e.image}" alt="${e.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
           <i class="fas fa-user" style="display: none;"></i>`:'<i class="fas fa-user"></i>',c=[{icon:"venus-mars",label:"Gender",value:e.gender||"Not specified"},{icon:"heart",label:"Status",value:e.maritalStatus||"Not specified"},{icon:"pray",label:"Religion",value:e.religion||"Not specified"},{icon:"calendar-alt",label:"Born",value:b(e.dob)||"Unknown"}];i&&c.push({icon:"cross",label:"Died",value:b(e.dod)});const r=c.map(d=>`
        <div class="detail-item">
          <i class="fas fa-${d.icon}"></i>
          <span>${d.value}</span>
        </div>
      `).join("");if(t.innerHTML=`
        <div class="card-header">
          <div class="avatar-container">
            <div class="avatar">
              ${a}
            </div>
            <div class="status-indicator" style="background: ${l};"></div>
          </div>
          <div class="member-info">
            <div class="member-name">
              ${e.name}
              <span class="serial-badge">#${e.serial||"N/A"}</span>
            </div>
            <div class="member-details">
              ${r}
            </div>
            ${e.notes?`<div class="member-notes"><i class="fas fa-quote-left"></i> ${e.notes}</div>`:""}
          </div>
        </div>
        <div class="card-actions">
          <button class="btn btn-success btn-sm" onclick="showModal('spouse', '${o}')">
            <i class="fas fa-ring"></i> Add Spouse
          </button>
          <button class="btn btn-primary btn-sm" onclick="showModal('child', '${o}')">
            <i class="fas fa-baby"></i> Add Child
          </button>
          <button class="btn btn-warning btn-sm" onclick="showModal('edit', '${o}')">
            <i class="fas fa-edit"></i> Edit
          </button>
          ${o!=="root"?`<button class="btn btn-danger btn-sm" onclick="deleteMember('${o}')"><i class="fas fa-trash"></i> Delete</button>`:""}
        </div>
      `,e.spouses&&e.spouses.length>0){const d=S("spouses",o,e,"Spouses","ring",s);t.appendChild(d)}if(e.children&&e.children.length>0){const d=S("children",o,e,"Children","users",s);t.appendChild(d)}return t}function S(e,n,o,s,t,i){const l=document.createElement("div");l.className="tree-connections";const a=`${n}.${e}`,c=y(a),r=document.createElement("div");r.className="section-header",r.innerHTML=`
        <button class="toggle-btn ${c?"expanded":""}" >
          <i class="fas fa-chevron-right"></i>
        </button>
        <i class="fas fa-${t}"></i>
        <span class="section-title">${s} (${o[e].length})</span>
      `,r.onclick=()=>L(a);const d=document.createElement("div");return d.className=`section-content ${c?"expanded":"collapsed"}`,d.id=`section-${a.replace(/[\[\].]/g,"-")}`,c&&o[e].forEach((f,p)=>{const $=m(f,o,`${n}.${e}[${p}]`,i+1);d.appendChild($)}),l.appendChild(r),l.appendChild(d),l}function L(e){const n=y(e);h[e]=!n;const o=`section-${e.replace(/[\[\].]/g,"-")}`,s=document.getElementById(o),t=s.parentElement.querySelector(".toggle-btn"),i=t.parentElement;if(n)t.classList.remove("expanded"),i.classList.remove("expanded"),s.className="section-content collapsed",setTimeout(()=>{s.classList.contains("collapsed")&&(s.innerHTML="")},400);else{t.classList.add("expanded"),i.classList.add("expanded"),s.className="section-content expanded";const l=e.split("."),a=l[l.length-1],c=l.slice(0,-1).join("."),r=g(c);if(s.innerHTML="",r[a]&&r[a].length>0){const d=l.length-1;r[a].forEach((f,p)=>{const $=m(f,r,`${c}.${a}[${p}]`,d);s.appendChild($)})}}}function y(e){return h[e]!==!1}function M(){h={},N()}async function B(){if(+await prompt("Enter your secret code to unlock controls")==7889){const n=await prompt("Enter your role to unlock controls");["root","admin","writer","reader"].includes(n)&&(localStorage.setItem("role",n),document.querySelector(".container").setAttribute("role",n))}}function C(){function e(n,o){n.spouses&&n.spouses.length>0&&(h[o+".spouses"]=!1,n.spouses.forEach((s,t)=>{e(s,o+`.spouses[${t}]`)})),n.children&&n.children.length>0&&(h[o+".children"]=!1,n.children.forEach((s,t)=>{e(s,o+`.children[${t}]`)}))}e(u.rootPerson,"root"),N()}function O(e,n){const o=document.getElementById("modal"),s=document.getElementById("memberForm"),t=document.getElementById("modalTitle"),i=document.getElementById("modalSubtitle");s.reset();let l={};e==="edit"?(l=g(n),t.textContent="Edit Family Member",i.textContent=`Update information for ${l.name}`,Object.keys(l).forEach(a=>{const c=s.querySelector(`[name="${a}"]`);c&&l[a]!==null&&l[a]!==void 0&&(c.value=l[a])})):(t.textContent=e==="spouse"?"Add Spouse":"Add Child",i.textContent=`Add new ${e} to the family tree`),s.dataset.type=e,s.dataset.path=n,o.classList.add("show")}function w(){document.getElementById("modal").classList.remove("show")}document.getElementById("memberForm").addEventListener("submit",function(e){e.preventDefault();const n=new FormData(this),o={};for(let[i,l]of n.entries())l.trim()&&(o[i]=l.trim());const s=this.dataset.type,t=this.dataset.path;if(s==="edit"){const i=g(t);Object.assign(i,o);const l=document.querySelector(`[data-path="${t}"]`),a=m(i,null,t,0);l.parentNode.replaceChild(a,l)}else{o.serial=v(u.rootPerson)+1,o.spouses=[],o.children=[];const i=g(t);if(s==="spouse"){i.spouses=i.spouses||[],i.spouses.push(o);const a=`${t}.spouses`;if(y(a)){const c=`section-${a.replace(/[\[\].]/g,"-")}`,r=document.getElementById(c);if(r){const d=i.spouses.length-1,f=m(o,i,`${t}.spouses[${d}]`,t.split(".").length);r.appendChild(f)}}}else if(s==="child"){i.children=i.children||[],i.children.push(o);const a=`${t}.children`;if(y(a)){const c=`section-${a.replace(/[\[\].]/g,"-")}`,r=document.getElementById(c);if(r){const d=i.children.length-1,f=m(o,i,`${t}.children[${d}]`,t.split(".").length);r.appendChild(f)}}}const l=document.querySelector(`[data-path="${t}"]`);l&&l.querySelectorAll(".section-title").forEach(c=>{const r=c.textContent;s==="spouse"&&r.includes("Spouses")?c.textContent=`Spouses (${i.spouses.length})`:s==="child"&&r.includes("Children")&&(c.textContent=`Children (${i.children.length})`)})}w(),E()});function E(){const e=JSON.stringify(u,null,2);fetch(x+"family",{method:"POST",headers:{"Content-Type":"application/json"},body:e}).then(n=>{n.ok?console.log("Family tree exported successfully!"):alert("Error exporting family tree: "+n.statusText)}).catch(n=>{alert("Error exporting family tree: "+n.message)})}function A(e){if(!confirm("Are you sure you want to delete this member and all their descendants?"))return;const n=e.split("."),o=n.pop(),s=n.join("."),t=g(s),i=o.match(/(\w+)\[(\d+)\]/);if(i){const l=i[1],a=parseInt(i[2]);if(t&&t[l]){t[l].splice(a,1);const c=document.querySelector(`[data-path="${e}"]`);c&&c.remove();const r=document.querySelector(`[data-path="${s}"]`);r&&r.querySelectorAll(".section-title").forEach(f=>{const p=f.textContent;l==="spouses"&&p.includes("Spouses")?f.textContent=`Spouses (${t.spouses.length})`:l==="children"&&p.includes("Children")&&(f.textContent=`Children (${t.children.length})`)})}}E()}function g(e){if(e==="root")return u.rootPerson;let n=u.rootPerson;const o=/(\w+)\[(\d+)\]/g;let s;for(;(s=o.exec(e))!==null;){const t=s[1],i=parseInt(s[2]);n=n[t][i]}return n}function v(e,n=0){return e&&(e.serial&&e.serial>n&&(n=e.serial),e.spouses&&e.spouses.forEach(o=>{o.serial&&o.serial>n&&(n=o.serial),o.children&&o.children.forEach(s=>{n=v(s,n)})}),e.children&&e.children.forEach(o=>{n=v(o,n)})),n}function b(e){if(!e||e.trim()==="")return null;try{return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}catch{return e}}async function T(){if(!u){alert("No data to export");return}const e=JSON.stringify(u,null,2),n=new Blob([e],{type:"application/json"}),o=URL.createObjectURL(n),s=document.createElement("a");s.href=o,s.download=`${u.familyName||"family_tree"}.json`,document.body.appendChild(s),s.click(),setTimeout(()=>{document.body.removeChild(s),URL.revokeObjectURL(o)},100)}function D(e){const n=e.target.files[0];if(!n)return;const o=new FileReader;o.onload=function(s){try{const t=JSON.parse(s.target.result);t.familyName&&t.rootPerson?(u=t,h={},C(),E(),console.log("Family tree imported successfully!")):alert("Invalid family tree JSON structure.")}catch(t){alert("Error parsing JSON: "+t.message)}},o.readAsText(n),e.target.value=""}document.getElementById("modal").addEventListener("click",function(e){e.target===this&&w()});window.showModal=O;window.closeModal=w;window.deleteMember=A;window.toggleSection=L;window.expandAll=M;window.collapseAll=C;window.exportJSON=T;window.importJSON=D;window.onDBClick=B;
