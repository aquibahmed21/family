(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function n(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerPolicy&&(a.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?a.credentials="include":t.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(t){if(t.ep)return;t.ep=!0;const a=n(t);fetch(t.href,a)}})();let f=null,C={};const R="https://web-push-3zaz.onrender.com/";document.addEventListener("DOMContentLoaded",function(){const e=localStorage.getItem("role")||"reader";document.querySelector(".container").setAttribute("role",e),V(),j()});function V(){f=U(),f&&(document.getElementById("loadingState").style.display="none",document.getElementById("treeContent").style.display="block",A(),document.querySelector("#lastUpdated").textContent=Y(f.date??0)),fetch(R+"family").then(e=>e.json()).then(e=>{ee(e)&&(f=e,Z(f),document.getElementById("loadingState").style.display="none",document.getElementById("treeContent").style.display="block",A())}).catch(e=>{document.getElementById("loadingState").innerHTML=`
            <i class="fas fa-exclamation-triangle" style="color: var(--warning-color); margin-right: 0.5rem;"></i>
            Failed to load family tree: ${e.message}
          `})}function O(){if(!f||!f.rootPerson)return;document.getElementById("familyName").textContent=f.familyName||"Family Tree";const e=document.getElementById("treeContent");e.innerHTML="",e.appendChild(B(f.rootPerson,null,"root",0))}function G(){const e=[];function s(n,o){n&&(e.push({name:n.name||"",serial:n.serial||null,gender:n.gender||"",maritalStatus:n.maritalStatus||"",spousesCount:n.spouses&&n.spouses.length||0,childrenCount:n.children&&n.children.length||0,path:o}),n.spouses&&n.spouses.forEach((t,a)=>s(t,`${o}.spouses[${a}]`)),n.children&&n.children.forEach((t,a)=>s(t,`${o}.children[${a}]`)))}return f&&f.rootPerson&&s(f.rootPerson,"root"),e}function j(){const e=document.getElementById("searchInput"),s=document.getElementById("searchResults"),n=document.getElementById("applyFiltersBtn"),o=document.getElementById("clearFiltersBtn"),t=document.getElementById("backToResultsBtn"),a=document.getElementById("filterGender"),l=document.getElementById("filterMarital"),i=document.getElementById("filterChildren"),r=document.getElementById("filterSpouses"),c=document.getElementById("filterResults");if(!e||!n||!c)return;const d=()=>{var p;return((p=document.querySelector(".container"))==null?void 0:p.getAttribute("role"))||"reader"};let m="";function h(){const p=(e.value||"").trim().toLowerCase(),T=(a==null?void 0:a.value)||"",b=(l==null?void 0:l.value)||"",E=(i==null?void 0:i.value)||"",$=(r==null?void 0:r.value)||"",y=G().filter(u=>{if(T&&u.gender!==T||b&&u.maritalStatus!==b||E==="yes"&&u.childrenCount<=0||E==="no"&&u.childrenCount>0||$==="yes"&&u.spousesCount<=0||$==="no"&&u.spousesCount>0)return!1;if(p){const L=u.name.toLowerCase().includes(p),D=p.startsWith("#")?u.serial!==null&&`#${u.serial}`===p:u.serial!==null&&`${u.serial}`===p;if(!L&&!D)return!1}return!0}).slice(0,300),v=d();c.innerHTML=y.length?y.map(u=>{const L=v==="reader"?"Private":u.name||"Unnamed",D=v==="reader"?"":u.maritalStatus?" 路 "+u.maritalStatus:"";return`<div class="result-item" data-path="${u.path}">
         <strong>${L}</strong>
         <small>#${u.serial??"N/A"} 路 ${u.gender}${D} 路 Sp:${u.spousesCount} 路 Ch:${u.childrenCount}</small>
       </div>`}).join(""):'<div class="text-muted">No results</div>',c.onclick=u=>{const L=u.target.closest(".result-item");L&&J(L.getAttribute("data-path"))},s&&(s.style.display="none",s.innerHTML=""),m=c.innerHTML;const I=document.getElementById("resultsCount");I&&(I.textContent=y.length?`Results (${y.length})`:"")}let g=null;e.addEventListener("input",()=>{g&&cancelAnimationFrame(g),g=requestAnimationFrame(()=>{h(),g=null})}),n.addEventListener("click",h),a==null||a.addEventListener("change",h),l==null||l.addEventListener("change",h),i==null||i.addEventListener("change",h),r==null||r.addEventListener("change",h),o&&o.addEventListener("click",()=>{a&&(a.value=""),l&&(l.value=""),i&&(i.value=""),r&&(r.value=""),e&&(e.value=""),c.innerHTML="";const p=document.getElementById("resultsCount");p&&(p.textContent="")});const w=document.getElementById("clearSearchBtn");w&&w.addEventListener("click",()=>{e&&(e.value=""),h()}),t&&t.addEventListener("click",()=>{c.innerHTML=m,t.style.display="none"})}async function J(e){if(!e)return;const s=document.getElementById("backToResultsBtn");s&&(s.style.display="inline-flex");const n=[];let o="root";const t=/(?:^|\.)((?:spouses|children))\[(\d+)\]/g;let a;for(;(a=t.exec(e))!==null;){const i=a[1],r=a[2];n.push(`${o}.${i}`),o=`${o}.${i}[${r}]`}n.forEach(i=>{C[i]=!0}),O();for(const i of n){const r=`section-${i.replace(/[\[\].]/g,"-")}`,c=document.getElementById(r);c&&c.classList.contains("collapsed")&&(F(i),await new Promise(d=>requestAnimationFrame(d)))}await new Promise(i=>requestAnimationFrame(i));const l=document.querySelector(`.member-card[data-path="${e}"]`);l&&(l.scrollIntoView({behavior:"smooth",block:"center"}),l.classList.add("highlight"),l.addEventListener("animationend",()=>{l.classList.remove("highlight")},{once:!0}))}function B(e,s,n,o){const t=document.createElement("div");t.className="member-card"+(e.gender=="Female"?" female":" male"),t.style.animationDelay=`${o*.1}s`,t.setAttribute("data-path",n);const a=e.dod&&e.dod.trim()!==""||e.status&&e.status.toLowerCase()==="deceased",l=a?"var(--text-muted)":"var(--success-color)",i=e.image?`<img src="${e.image}" alt="${e.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
           <i class="fas fa-user" style="display: none;"></i>`:'<i class="fas fa-user"></i>',r=[{icon:"venus-mars",label:"Gender",value:e.gender||"Not specified"},{icon:"heart",label:"Status",value:e.maritalStatus||"Not specified"},{icon:"pray",label:"Religion",value:e.religion||"Not specified"}];N(e.dob)&&r.push({icon:"calendar-alt",label:"Born",value:N(e.dob)||"Unknown"}),a&&N(e.dod)&&r.push({icon:"cross",label:"Died",value:N(e.dod)});const c=r.map(d=>`
        <div class="detail-item" value="${d.value}">
          <i class="fas fa-${d.icon}"></i>
          <span>${d.value}</span>
        </div>
      `).join("");if(t.innerHTML=`
        <div class="card-header">
          <div class="avatar-container">
            <div class="avatar">
              ${i}
            </div>
            <div class="status-indicator" style="background: ${l};"></div>
          </div>
          <div class="member-info">
            <div class="member-name">
              ${e.name?`<span class="name">${e.name}</span>`:""}
              <span class="serial-badge">#${e.serial||"N/A"}</span>
              ${e.alternateName?`<span class="alternate-name">(${e.alternateName})</span>`:""}
            </div>
            <div class="member-details">
              ${c}
            </div>
            ${e.notes?`<div class="member-notes"><i class="fas fa-quote-left"></i> ${e.notes}</div>`:""}
          </div>
        </div>
        <div class="card-actions">
          <button class="btn btn-success btn-sm" onclick="showModal('spouse', '${n}')">
            <i class="fas fa-ring"></i> Add Spouse
          </button>
          <button class="btn btn-primary btn-sm" onclick="showModal('child', '${n}')">
            <i class="fas fa-baby"></i> Add Child
          </button>
          <button class="btn btn-warning btn-sm" onclick="showModal('edit', '${n}')">
            <i class="fas fa-edit"></i> Edit
          </button>
          ${n!=="root"?`<button class="btn btn-danger btn-sm" onclick="deleteMember('${n}')"><i class="fas fa-trash"></i> Delete</button>`:""}
        </div>
      `,e.spouses&&e.spouses.length>0){const d=H("spouses",n,e,"Spouses","ring",o);t.appendChild(d)}if(e.children&&e.children.length>0){const d=H("children",n,e,"Children","users",o);t.appendChild(d)}return t.setAttribute("privacy",e.privacy||"public"),t}function H(e,s,n,o,t,a){const l=document.createElement("div");l.className="tree-connections";const i=`${s}.${e}`,r=M(i),c=document.createElement("div");c.className="section-header",c.innerHTML=`
        <button class="toggle-btn ${r?"expanded":""}" >
          <i class="fas fa-chevron-right"></i>
        </button>
        <i class="fas fa-${t}"></i>
        <span class="section-title" mValue="${n[e].length}">${o}</span>
      `,c.onclick=()=>F(i);const d=document.createElement("div");return d.className=`section-content ${r?"expanded":"collapsed"}`,d.id=`section-${i.replace(/[\[\].]/g,"-")}`,r&&n[e].forEach((m,h)=>{const g=B(m,n,`${s}.${e}[${h}]`,a+1);d.appendChild(g)}),l.appendChild(c),l.appendChild(d),l}function F(e){const s=M(e);C[e]=!s;const n=`section-${e.replace(/[\[\].]/g,"-")}`,o=document.getElementById(n),t=o.parentElement.querySelector(".toggle-btn"),a=t.parentElement;if(s){t.classList.remove("expanded"),a.classList.remove("expanded"),o.className="section-content collapsed";const l=()=>{o.removeEventListener("transitionend",l),o.classList.contains("collapsed")&&(o.innerHTML="")};o.addEventListener("transitionend",l)}else{t.classList.add("expanded"),a.classList.add("expanded"),o.className="section-content expanded";const l=e.split("."),i=l[l.length-1],r=l.slice(0,-1).join("."),c=x(r);if(o.innerHTML="",c[i]&&c[i].length>0){const d=l.length-1;c[i].forEach((m,h)=>{const g=B(m,c,`${r}.${i}[${h}]`,d);o.appendChild(g)})}}}function M(e){return C[e]!==!1}function z(){C={},O()}async function W(){if(+await prompt("Enter your secret code to unlock controls")==7889){const s=await prompt("Enter your role to unlock controls");if(["root","admin","writer","reader"].includes(s)){localStorage.setItem("role",s),document.querySelector(".container").setAttribute("role",s);return}}document.querySelector(".container").setAttribute("role","reader")}function A(){function e(s,n){s.spouses&&s.spouses.length>0&&(C[n+".spouses"]=!1,s.spouses.forEach((o,t)=>{e(o,n+`.spouses[${t}]`)})),s.children&&s.children.length>0&&(C[n+".children"]=!1,s.children.forEach((o,t)=>{e(o,n+`.children[${t}]`)}))}e(f.rootPerson,"root"),O()}function _(e,s){const n=document.getElementById("modal"),o=document.getElementById("memberForm"),t=document.getElementById("modalTitle"),a=document.getElementById("modalSubtitle");o.reset();let l={};e==="edit"?(l=x(s),t.textContent="Edit Family Member",a.textContent=`Update information for ${l.name}`,Object.keys(l).forEach(i=>{const r=o.querySelector(`[name="${i}"]`);["gender","privacy","status","maritalStatus"].includes(i)?o.querySelector(`[value="${l[i]}"]`).checked=!0:r&&l[i]!==null&&l[i]!==void 0&&(r.value=l[i])})):(t.textContent=e==="spouse"?"Add Spouse":"Add Child",a.textContent=`Add new ${e} to the family tree`),o.dataset.type=e,o.dataset.path=s,n.classList.add("show")}function q(){document.getElementById("modal").classList.remove("show")}document.getElementById("memberForm").addEventListener("submit",function(e){e.preventDefault();const s=new FormData(this),n={};for(let[a,l]of s.entries())l.trim()&&(n[a]=l.trim());const o=this.dataset.type,t=this.dataset.path;if(o==="edit"){const a=x(t);Object.assign(a,n);const l=document.querySelector(`[data-path="${t}"]`),i=B(a,null,t,0);l.parentNode.replaceChild(i,l)}else{n.serial=P(f.rootPerson)+1,n.spouses=[],n.children=[];const a=x(t);if(o==="spouse"){a.spouses=a.spouses||[],a.spouses.push(n);const i=`${t}.spouses`;if(M(i)){const r=`section-${i.replace(/[\[\].]/g,"-")}`,c=document.getElementById(r);if(c){const d=a.spouses.length-1,m=B(n,a,`${t}.spouses[${d}]`,t.split(".").length);c.appendChild(m)}}}else if(o==="child"){a.children=a.children||[],a.children.push(n);const i=`${t}.children`;if(M(i)){const r=`section-${i.replace(/[\[\].]/g,"-")}`,c=document.getElementById(r);if(c){const d=a.children.length-1,m=B(n,a,`${t}.children[${d}]`,t.split(".").length);c.appendChild(m)}}}const l=document.querySelector(`[data-path="${t}"]`);l&&l.querySelectorAll(".section-title").forEach(r=>{const c=r.textContent;o==="spouse"&&c.includes("Spouses")?(r.textContent="Spouses",r.setAttribute("mValue",a.spouses.length)):o==="child"&&c.includes("Children")&&(r.textContent=`Children (${a.children.length})`,r.setAttribute("mValue",a.children.length))})}q(),k()});function k(){f.date=new Date().getTime(),document.querySelector("#lastUpdated").textContent=Y(f.date);const e=JSON.stringify(f,null,2);fetch(R+"family",{method:"POST",headers:{"Content-Type":"application/json"},body:e}).then(s=>{s.ok?console.log("Family tree exported successfully!"):alert("Error exporting family tree: "+s.statusText)}).catch(s=>{alert("Error exporting family tree: "+s.message)})}function K(e){if(!confirm("Are you sure you want to delete this member and all their descendants?"))return;const s=e.split("."),n=s.pop(),o=s.join("."),t=x(o),a=n.match(/(\w+)\[(\d+)\]/);if(a){const l=a[1],i=parseInt(a[2]);if(t&&t[l]){t[l].splice(i,1);const r=document.querySelector(`[data-path="${e}"]`);r&&r.remove();const c=document.querySelector(`[data-path="${o}"]`);c&&c.querySelectorAll(".section-title").forEach(m=>{const h=m.textContent;l==="spouses"&&h.includes("Spouses")?(m.textContent="Spouses",m.setAttribute("value",t.spouses.length)):l==="children"&&h.includes("Children")&&(m.textContent="Children",m.setAttribute("value",t.children.length))})}}k()}function x(e){if(e==="root")return f.rootPerson;let s=f.rootPerson;const n=/(\w+)\[(\d+)\]/g;let o;for(;(o=n.exec(e))!==null;){const t=o[1],a=parseInt(o[2]);s=s[t][a]}return s}function P(e,s=0){return e&&(e.serial&&e.serial>s&&(s=e.serial),e.spouses&&e.spouses.forEach(n=>{n.serial&&n.serial>s&&(s=n.serial),n.children&&n.children.forEach(o=>{s=P(o,s)})}),e.children&&e.children.forEach(n=>{s=P(n,s)})),s}function N(e){if(!e||e.trim()==="")return null;try{return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}catch{return e}}async function Q(){if(!f){alert("No data to export");return}const e=JSON.stringify(f,null,2),s=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(s),o=document.createElement("a");o.href=n,o.download=`${f.familyName||"family_tree"}.json`,document.body.appendChild(o),o.click(),setTimeout(()=>{document.body.removeChild(o),URL.revokeObjectURL(n)},100)}function X(e){const s=e.target.files[0];if(!s)return;const n=new FileReader;n.onload=function(o){try{const t=JSON.parse(o.target.result);t.familyName&&t.rootPerson?(f=t,C={},A(),k(),console.log("Family tree imported successfully!")):alert("Invalid family tree JSON structure.")}catch(t){alert("Error parsing JSON: "+t.message)}},n.readAsText(s),e.target.value=""}document.getElementById("modal").addEventListener("click",function(e){e.target===this&&q()});function Z(e){localStorage.setItem("familyTreeData",JSON.stringify(e))}function U(){const e=localStorage.getItem("familyTreeData");return e?JSON.parse(e):null}function ee(e){const s=U();return!s||!s.date?!0:s.date!==e.date}function Y(e,s=!1,n=!1){if(e<=0)return"--";let o=new Date(e),t=o.getDate(),a=o.getMonth(),l=o.getDay(),i=["Sun","Mon","Tue","Wed","Thur","Fri","Sat"][l],r=o.getFullYear(),c=o.getHours(),d=c%12;d=n?d||12:c;let m=n?c>=12?"pm":"am":"",h=o.getMinutes(),g=o.getSeconds(),w=("00"+d).slice(-2)+":"+("00"+h).slice(-2);s&&(w+=":"+("00"+g).slice(-2));let p=n?w+" "+m:w,b=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a],E=("00"+t).slice(-2)+"-"+b,$=new Date,S=$.getFullYear(),y=$.getMonth(),v=$.getDate(),I=$.getDay(),u=t>v?t-v:v-t;return r==S&&a==y&&t==v?p:r==S&&a==y&&v-t==1?"Y'day, "+p:r==S&&a==y&&l!=I&&u<=7?E+", "+i+", "+p:r==S&&a==y&&t==v?p:(r==S||(E+="-"+r),E+", "+p)}window.showModal=_;window.closeModal=q;window.deleteMember=K;window.toggleSection=F;window.expandAll=z;window.collapseAll=A;window.exportJSON=Q;window.importJSON=X;window.onDBClick=W;window.navigateToPath=J;
