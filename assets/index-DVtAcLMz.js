(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const i of t)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function s(t){const i={};return t.integrity&&(i.integrity=t.integrity),t.referrerPolicy&&(i.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?i.credentials="include":t.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(t){if(t.ep)return;t.ep=!0;const i=s(t);fetch(t.href,i)}})();let u=null,h={};const x=window.location.hostname==="localhost"?"http://localhost:3000/":"https://web-push-3zaz.onrender.com/";document.addEventListener("DOMContentLoaded",function(){const e=localStorage.getItem("role")||"reader";document.querySelector(".container").setAttribute("role",e),I()});function I(){fetch(x+"family").then(e=>e.json()).then(e=>{u=e,document.getElementById("loadingState").style.display="none",document.getElementById("treeContent").style.display="block",w()}).catch(e=>{document.getElementById("loadingState").innerHTML=`
            <i class="fas fa-exclamation-triangle" style="color: var(--warning-color); margin-right: 0.5rem;"></i>
            Failed to load family tree: ${e.message}
          `})}function N(){if(!u||!u.rootPerson)return;document.getElementById("familyName").textContent=u.familyName||"Family Tree";const e=document.getElementById("treeContent");e.innerHTML="",e.appendChild(m(u.rootPerson,null,"root",0))}function m(e,n,s,o){const t=document.createElement("div");t.className="member-card"+(e.gender=="Female"?" female":" male"),t.style.animationDelay=`${o*.1}s`,t.setAttribute("data-path",s);const i=e.dod&&e.dod.trim()!==""||e.status&&e.status.toLowerCase()==="deceased",a=i?"var(--text-muted)":"var(--success-color)",l=e.image?`<img src="${e.image}" alt="${e.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
           <i class="fas fa-user" style="display: none;"></i>`:'<i class="fas fa-user"></i>',c=[{icon:"venus-mars",label:"Gender",value:e.gender||"Not specified"},{icon:"heart",label:"Status",value:e.maritalStatus||"Not specified"},{icon:"pray",label:"Religion",value:e.religion||"Not specified"}];y(e.dob)&&c.push({icon:"calendar-alt",label:"Born",value:y(e.dob)||"Unknown"}),i&&y(e.dod)&&c.push({icon:"cross",label:"Died",value:y(e.dod)});const r=c.map(d=>`
        <div class="detail-item">
          <i class="fas fa-${d.icon}"></i>
          <span>${d.value}</span>
        </div>
      `).join("");if(t.innerHTML=`
        <div class="card-header">
          <div class="avatar-container">
            <div class="avatar">
              ${l}
            </div>
            <div class="status-indicator" style="background: ${a};"></div>
          </div>
          <div class="member-info">
            <div class="member-name">
              ${e.name?`<span class="name">${e.name}</span>`:""}
              <span class="serial-badge">#${e.serial||"N/A"}</span>
              ${e.alternateName?`<span class="alternate-name">(${e.alternateName})</span>`:""}
            </div>
            <div class="member-details">
              ${r}
            </div>
            ${e.notes?`<div class="member-notes"><i class="fas fa-quote-left"></i> ${e.notes}</div>`:""}
          </div>
        </div>
        <div class="card-actions">
          <button class="btn btn-success btn-sm" onclick="showModal('spouse', '${s}')">
            <i class="fas fa-ring"></i> Add Spouse
          </button>
          <button class="btn btn-primary btn-sm" onclick="showModal('child', '${s}')">
            <i class="fas fa-baby"></i> Add Child
          </button>
          <button class="btn btn-warning btn-sm" onclick="showModal('edit', '${s}')">
            <i class="fas fa-edit"></i> Edit
          </button>
          ${s!=="root"?`<button class="btn btn-danger btn-sm" onclick="deleteMember('${s}')"><i class="fas fa-trash"></i> Delete</button>`:""}
        </div>
      `,e.spouses&&e.spouses.length>0){const d=b("spouses",s,e,"Spouses","ring",o);t.appendChild(d)}if(e.children&&e.children.length>0){const d=b("children",s,e,"Children","users",o);t.appendChild(d)}return t.setAttribute("privacy",e.privacy||"public"),t}function b(e,n,s,o,t,i){const a=document.createElement("div");a.className="tree-connections";const l=`${n}.${e}`,c=$(l),r=document.createElement("div");r.className="section-header",r.innerHTML=`
        <button class="toggle-btn ${c?"expanded":""}" >
          <i class="fas fa-chevron-right"></i>
        </button>
        <i class="fas fa-${t}"></i>
        <span class="section-title">${o} (${s[e].length})</span>
      `,r.onclick=()=>L(l);const d=document.createElement("div");return d.className=`section-content ${c?"expanded":"collapsed"}`,d.id=`section-${l.replace(/[\[\].]/g,"-")}`,c&&s[e].forEach((f,p)=>{const v=m(f,s,`${n}.${e}[${p}]`,i+1);d.appendChild(v)}),a.appendChild(r),a.appendChild(d),a}function L(e){const n=$(e);h[e]=!n;const s=`section-${e.replace(/[\[\].]/g,"-")}`,o=document.getElementById(s),t=o.parentElement.querySelector(".toggle-btn"),i=t.parentElement;if(n)t.classList.remove("expanded"),i.classList.remove("expanded"),o.className="section-content collapsed",setTimeout(()=>{o.classList.contains("collapsed")&&(o.innerHTML="")},400);else{t.classList.add("expanded"),i.classList.add("expanded"),o.className="section-content expanded";const a=e.split("."),l=a[a.length-1],c=a.slice(0,-1).join("."),r=g(c);if(o.innerHTML="",r[l]&&r[l].length>0){const d=a.length-1;r[l].forEach((f,p)=>{const v=m(f,r,`${c}.${l}[${p}]`,d);o.appendChild(v)})}}}function $(e){return h[e]!==!1}function M(){h={},N()}async function B(){if(+await prompt("Enter your secret code to unlock controls")==7889){const n=await prompt("Enter your role to unlock controls");["root","admin","writer","reader"].includes(n)&&(localStorage.setItem("role",n),document.querySelector(".container").setAttribute("role",n))}}function w(){function e(n,s){n.spouses&&n.spouses.length>0&&(h[s+".spouses"]=!1,n.spouses.forEach((o,t)=>{e(o,s+`.spouses[${t}]`)})),n.children&&n.children.length>0&&(h[s+".children"]=!1,n.children.forEach((o,t)=>{e(o,s+`.children[${t}]`)}))}e(u.rootPerson,"root"),N()}function O(e,n){const s=document.getElementById("modal"),o=document.getElementById("memberForm"),t=document.getElementById("modalTitle"),i=document.getElementById("modalSubtitle");o.reset();let a={};e==="edit"?(a=g(n),t.textContent="Edit Family Member",i.textContent=`Update information for ${a.name}`,Object.keys(a).forEach(l=>{const c=o.querySelector(`[name="${l}"]`);["gender","privacy","status","maritalStatus"].includes(l)?o.querySelector(`[value="${a[l]}"]`).checked=!0:c&&a[l]!==null&&a[l]!==void 0&&(c.value=a[l])})):(t.textContent=e==="spouse"?"Add Spouse":"Add Child",i.textContent=`Add new ${e} to the family tree`),o.dataset.type=e,o.dataset.path=n,s.classList.add("show")}function E(){document.getElementById("modal").classList.remove("show")}document.getElementById("memberForm").addEventListener("submit",function(e){e.preventDefault();const n=new FormData(this),s={};for(let[i,a]of n.entries())a.trim()&&(s[i]=a.trim());const o=this.dataset.type,t=this.dataset.path;if(o==="edit"){const i=g(t);Object.assign(i,s);const a=document.querySelector(`[data-path="${t}"]`),l=m(i,null,t,0);a.parentNode.replaceChild(l,a)}else{s.serial=C(u.rootPerson)+1,s.spouses=[],s.children=[];const i=g(t);if(o==="spouse"){i.spouses=i.spouses||[],i.spouses.push(s);const l=`${t}.spouses`;if($(l)){const c=`section-${l.replace(/[\[\].]/g,"-")}`,r=document.getElementById(c);if(r){const d=i.spouses.length-1,f=m(s,i,`${t}.spouses[${d}]`,t.split(".").length);r.appendChild(f)}}}else if(o==="child"){i.children=i.children||[],i.children.push(s);const l=`${t}.children`;if($(l)){const c=`section-${l.replace(/[\[\].]/g,"-")}`,r=document.getElementById(c);if(r){const d=i.children.length-1,f=m(s,i,`${t}.children[${d}]`,t.split(".").length);r.appendChild(f)}}}const a=document.querySelector(`[data-path="${t}"]`);a&&a.querySelectorAll(".section-title").forEach(c=>{const r=c.textContent;o==="spouse"&&r.includes("Spouses")?c.textContent=`Spouses (${i.spouses.length})`:o==="child"&&r.includes("Children")&&(c.textContent=`Children (${i.children.length})`)})}E(),S()});function S(){const e=JSON.stringify(u,null,2);fetch(x+"family",{method:"POST",headers:{"Content-Type":"application/json"},body:e}).then(n=>{n.ok?console.log("Family tree exported successfully!"):alert("Error exporting family tree: "+n.statusText)}).catch(n=>{alert("Error exporting family tree: "+n.message)})}function A(e){if(!confirm("Are you sure you want to delete this member and all their descendants?"))return;const n=e.split("."),s=n.pop(),o=n.join("."),t=g(o),i=s.match(/(\w+)\[(\d+)\]/);if(i){const a=i[1],l=parseInt(i[2]);if(t&&t[a]){t[a].splice(l,1);const c=document.querySelector(`[data-path="${e}"]`);c&&c.remove();const r=document.querySelector(`[data-path="${o}"]`);r&&r.querySelectorAll(".section-title").forEach(f=>{const p=f.textContent;a==="spouses"&&p.includes("Spouses")?f.textContent=`Spouses (${t.spouses.length})`:a==="children"&&p.includes("Children")&&(f.textContent=`Children (${t.children.length})`)})}}S()}function g(e){if(e==="root")return u.rootPerson;let n=u.rootPerson;const s=/(\w+)\[(\d+)\]/g;let o;for(;(o=s.exec(e))!==null;){const t=o[1],i=parseInt(o[2]);n=n[t][i]}return n}function C(e,n=0){return e&&(e.serial&&e.serial>n&&(n=e.serial),e.spouses&&e.spouses.forEach(s=>{s.serial&&s.serial>n&&(n=s.serial),s.children&&s.children.forEach(o=>{n=C(o,n)})}),e.children&&e.children.forEach(s=>{n=C(s,n)})),n}function y(e){if(!e||e.trim()==="")return null;try{return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}catch{return e}}async function T(){if(!u){alert("No data to export");return}const e=JSON.stringify(u,null,2),n=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(n),o=document.createElement("a");o.href=s,o.download=`${u.familyName||"family_tree"}.json`,document.body.appendChild(o),o.click(),setTimeout(()=>{document.body.removeChild(o),URL.revokeObjectURL(s)},100)}function D(e){const n=e.target.files[0];if(!n)return;const s=new FileReader;s.onload=function(o){try{const t=JSON.parse(o.target.result);t.familyName&&t.rootPerson?(u=t,h={},w(),S(),console.log("Family tree imported successfully!")):alert("Invalid family tree JSON structure.")}catch(t){alert("Error parsing JSON: "+t.message)}},s.readAsText(n),e.target.value=""}document.getElementById("modal").addEventListener("click",function(e){e.target===this&&E()});window.showModal=O;window.closeModal=E;window.deleteMember=A;window.toggleSection=L;window.expandAll=M;window.collapseAll=w;window.exportJSON=T;window.importJSON=D;window.onDBClick=B;
